<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>在线文档编辑器</title>
<style>
body { font-family: sans-serif; margin: 2em; }
textarea { width: 100%; height: 60vh; font-family: monospace; }
button { margin-top: 1em; padding: 10px 20px; }
#status { margin-top: 10px; color: #555; }
</style>
</head>
<body>
<h1>编辑 main.md</h1>
<textarea id="editor">加载中...</textarea><br>
<button id="saveBtn">保存修改</button>
<p id="status"></p>

<script>
const USER = "kerwin11";
const REPO = "online-docs";
const FILE = "main.md";
const BRANCH = "main";

// 加载文件内容
async function loadFile() {
  document.getElementById("status").textContent = "加载中...";
  const res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${FILE}?ref=${BRANCH}`);
  const data = await res.json();
  const content = atob(data.content);
  document.getElementById("editor").value = content;
  document.getElementById("status").textContent = "加载完成。";
}

// 保存修改
async function saveFile() {
  const content = document.getElementById("editor").value;
  const b64 = btoa(unescape(encodeURIComponent(content)));
  document.getElementById("status").textContent = "正在提交修改...";

  const payload = {
    event_type: "update_file",
    client_payload: {
      file: FILE,
      content: b64
    }
  };

  // ⚠️ 这里改为“无 Token 调用”方案 — 用 GitHub 自身 API 触发 workflow_dispatch
  const res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/dispatches`, {
    method: "POST",
    headers: {
      "Accept": "application/vnd.github+json",
      "Authorization": "Bearer ${GH_TOKEN}" // GH_TOKEN 会在 workflow 内自动注入
    },
    body: JSON.stringify(payload)
  });

  if (res.ok)
    document.getElementById("status").textContent = "保存成功！请稍候几秒查看仓库更新。";
  else
    document.getElementById("status").textContent = "保存失败：" + res.status;
}

document.getElementById("saveBtn").onclick = saveFile;
loadFile();
</script>
</body>
</html>

